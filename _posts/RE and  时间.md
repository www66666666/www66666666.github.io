<font style="font-size:1.3em;font-weight:bold;"> 目录 </font> 

[toc]


# 正则表达式

> 世界上最难懂的四件事： (╯▽╰ )
> 1. 道士的符文
> 2. 医生的处方
> 3. 女人的心
> 4. 程序员的正则

----

# 正则表达式

## 1. 正则简介

### 简介

正则表达式（英语：Regular Expression，在代码中常简写为 regex、regexp 或 RE），计算机科学的一个概念。正则表达式使用单个字符串来描述、匹配一系列符合某个句法规则的字符串。在很多文本编辑器里，正则表达式通常被用来检索、替换那些符合某个模式的文本。许多程序设计语言都支持利用正则表达式进行字符串操作。

### 历史

1940 年，Warren McCulloch（沃伦.麦卡洛克）与 Walter Pitts（沃尔特.皮茨）这两位神经生理方面的科学家，研究出了一种用数学方式来描述神经网络的新方法.将神经系统中的神经元描述成小而简单的自动控制元。

1950 年，数学家 Stephen Kleene（斯蒂芬·克莱尼）利用称之为“正则集合”的数学符号来描述此模型。

之后，Unix 之父：Ken Thompson（肯·汤普逊）将此符号系统引入编辑器 QED，随后是 Unix 上的编辑器 ed，并最终引入 grep。自此以后，正则表达式被广泛地应用于各种 Unix 或类 Unix 系统的工具中。

现在，你会在主流操作系统（Linux， Unix、Windows、HP、BeOS等）、主流的开发语言
（delphi、Scala、PHP、C#、Java、C++、Objective-c、Swift、VB、Javascript、Ruby以及Python等）、数以亿万计的各种应用软件中，都可以看到正则表达式的身影。

----

### 定义及用途

- 正则表达式也叫`模式表达式`
- 正则配合特定的函数，可实现字符串的匹配、查找、替换、分割等操作。
- 正则本质上也是一个字符串。
- 常见的正则用途：匹配手机号，邮箱验证，日期，帐号密码格式。

----

## 2. PHP正则的基本知识

> 在PHP程序中，正则表达式必须配合`正则处理函数`才能使用。
>
> PHP中支持正则表达式的处理函数是由`PCRE`库提供的，使用`preg_`作为前缀。

| `PCRE`库正则表达式函数   | 功能说明                                 |
| ----------------------- | ------------------------------------ |
| preg_match()            | 执行正则表达式匹配                   |
| preg_match_all()        | 执行全局正则表达式匹配               |
| preg_replace()          | 执行正则表达式的搜索和替换           |
| preg_split()            | 用正则表达式分割字符串               |
| preg_grep()             | 返回与模式匹配的数组单元             |
| preg_replace_callback() | 用回调函数执行正则表达式的搜索和替换 |

> 准备测试代码:

```php
$str = '此处输入要匹配的字符串';
$regExp = '此处提供正则表达式';

// 匹配验证
if ( preg_match($regExp, $str, $arr) ) {
    echo '正则表达式:
        <font size="5" color="#00f">' . $regExp . '</font><br>
        匹配字串:
        <font size="5" color="#00f">' . $str . '</font><hr>
        匹配结果:
        <font size="5" color="#0a0">成功</font><br>';

    echo '<pre>';
    print_r($arr); // 输出匹配到的结果
    echo '</pre>';
} else {
    echo '正则表达式:
        <font size="5" color="#00f">' . $regExp . '</font><br>
        匹配字串:
        <font size="5" color="#00f">' . $str . '</font><hr>
        匹配结果:
        <font size="5" color="#f00">失败</font><br>';
}
```

> PS. 测试正则
- [在线工具](https://tool.lu/regex/)
- [在线正则表达式测试](http://tool.oschina.net/regex/)
- [正则表达式工具 Match Tracer](http://www.regexlab.com/zh/mtracer/)

----

## 3. 正则语法规则

PHP中的正则表达式，由四部分构成：

- 定界符
- 原子
- 元字符
- 模式修正符

> 一个最简单的正则，至少要包含`定界符`和`一个原子`。

### 1. 定界符

每个正则表达式 都必须要有`一对定界符`。

除了数字、字母、反斜线以外的任意一个字符，都可以用来做为正则表达式的定界符。

如：`~!@#$%^&*_+:;<>.?|/ () {} []`，推荐使用 `/`

----

### 2. 原子

> 原子是组成正则表达式的最小单位，`一个原子 匹配 一个字符`。

#### 2.1 普通字符

`数字、字母、下划线： 0~9 a~z A~Z _`

#### 2.2 特殊字符

`'' "" / . * + ? | () [] & ^ \`

> 某些特殊字符 在正则里具有特殊意义，匹配此类字符时，
> 需要在正则里 使用反斜线 `\` 来转义，将其变成普通的原子

#### 2.3 非打印字符

```
\f  --  匹配 分页符
\r  --  匹配 回车符
\n  --  匹配 换行符
\t  --  匹配 制表符
\v  --  匹配 垂直制表符
```

#### 2.4 通用字符类型

```
\d  --  匹配 任意一个十进制数字[0~9]
\D  --  匹配 任意一个十进制数字以外的字符

\s  --  匹配 任意一个空白字符 [空格 tab \f\r\n\t\v]
\S  --  匹配 任意一个除了空白字符以外的字符

\w  --  匹配 任意一个数字/字母/下划线 [0~9 a~z A~Z _]
\W  --  匹配 除数字/字母/下划线以外的任意一个字符
```

#### 2.5 原子表

> 用`[]`中括号来表示 自定义的原子，依旧是只匹配一个字符。

```
[abc]   --  匹配 原子表中的 任意一个字符
[^abc]  --  匹配 除表内原子以外的 任意一个字符

另外，在原子表中可以使用 -（减号），来连接一组 ASCII 码顺序排列的原子。
[a-z]  --  匹配 从 a 到 z 的任意一个字母
```

----

### 3. 元字符

> 用来修饰其前面的`原子`出现的 `次数` 或 `位置`
>
> 元字符不能单独出现，它必须是用来修饰原子的。

#### 3.1 限定符

> 用来指定 前面的一个原子 出现多少次 才能满足匹配

```
*      --  匹配 其前面的一个原子 0次 1次 多次(任意多次)
+      --  匹配 其前面的一个原子 1次 多次(至少一次)
?      --  匹配 其前面的一个原子 0次 1次
{n}    --  匹配 其前面的一个原子 正好 n 次
{n,}   --  匹配 其前面的一个原子 至少 n 次
{n,m}  --  匹配 其前面的一个原子 至少 n 次，最多 m 次
```

#### 3.2 边界限制

```
^ 或 \A  --  匹配 字符串 开始的位置，表示必须以 某个字符串开头
$ 或 \Z  --  匹配 字符串 结束的位置，表示必须以 某个字符串结束

\b       --  匹配 单词边界
\B       --  匹配 非词边界，除单词边界以外的部分
写在前，就是限定该单词的前方，写在后，就是限定后方
```

#### 3.3 句号

`.` 匹配 任何一个字符，除了换行符(\n)。

#### 3.4 模式单元

`()` 把括号中的内容当成一个整体，当作一个大原子。
> () 内标记的原子，也叫做子模式。

#### 3.5 模式选择符

`|` 在多个模式之间，选择匹配到的那一个。

匹配是从左至右执行的，所以`容易`匹配的值放`右边`；`不易`匹配到的放`左边`。

#### 3.6 后向引用

```
\1  \2  \3     --  匹配 第1个、第2个、第3个 子模式的内容
\\1  \\2  \\3  --  匹配 第1个、第2个、第3个 子模式的内容(转义\)
```

用`()`标记的原子是一个子模式，也是一个独立的单元，所有子模式匹配的内容，都会被储存在临时缓存区，以被后用。

缓存区编号规则是：
从左向右，以左括号为 缓存标志，从 1 开始，连续编号，最大至 99 个子表达式。
每个缓存区都可以使用`\1`或`\\1`的形式去访问。

> 非捕获模式（忽略匹配）
>
> 当需要用到 模式单元，又不想存储 某个匹配子模式时，
>
> 可使用 非捕获元字符 `(?:)` 来忽略子模式的匹配。

----

### 4. 模式修正符

> 模式修正符 必须放在正则表达式之外使用。(右定界符之后)
>
> 它是用来扩展 正则的某些功能。
>
> 模式修正符可以组合使用。

````
i  --  不区分大小写
m  --  视为多行
s  --  视为一行
x  --  模式中的空白忽略不计，除非已经被转义
U  --  非贪婪模式(默认为贪婪模式)
(我没事就下个大游戏)
````

----

## 模式匹配的优先级

```
\
()  (?:)  (?=)  []
*  +  ?  {n}  {n,}  {n,m}
^  $  \b  \B  \A  \Z
|
```

----


# 错误处理

> PHP 处理错误的顺序

1. 首先，进行`语法检查`，有语法错误就阻止脚本执行。这类错误最常见，也必须修复。
2. 然后，通过语法检查之后，PHP 解析引擎开始逐行解析并运行代码。
3. 在`运行时`可能会发生一些`错误`，这类错误一般不会阻止脚本的运行，但会影响到脚本的执行结果。

## 1. 错误分类

- 语法错误
    - 语句无分号
    - 无分隔符/错误符号
    - 声明语句,缺少元素
- 运行时错误
    - 使用不存在的变量
    - 使用函数缺少参数
    - 遍历非数组 或 不存在数组
    - 调用不存在的函数
- 逻辑错误
    - 单一条件分支结构的使用错误,过早的结束
    - 运算符使用错误


----

## 2. 设置是否显示错误报告

- 在`php.ini`中设置是否显示 错误报告
    - `display_errors = Off`  关闭显示
    - `display_errors = On`   默认开启
- 在脚本中设置错误报告
    - `ini_get()` 获取`php.ini`文件中的某个配置项的值
    - `ini_set()` 设置`php.ini`文件中的某个配置项的值

以上两种设置错误的区别:
1. php.ini 设置是对整站有效
2. ini_set() 是临时设置,只对本脚本起作用,且无法控制语法错误

----

## 3. 错误报告级别及特性

| 值   | 常量    | 说明     |
| :----: | :-------: | :--------: |
| 8    | `NOTICE`  | 注意消息 |
| 2    | `WARNING` | 运行警告 |
| 1    | `ERROR`   | 致命错误 |

> 更多错误级别详见手册:
>
> 函数参考--->影响PHP行为的扩展--->错误处理--->预定义常量

----

## 4. 设置错误报告级别

1. 修改`php.ini`中的 `error_reporting` (Line 445)

| 值                | 说明         |
| :-----------------: | ------------ |
| `E_ALL`             | 显示所有错误 |
| `E_ALL & ~E_NOTICE` | 排除 NOTICE     |
| `E_ALL & ~(E_WARNING | E_NOTICE)` | 排除 WARNING 和 NOTICE |

2. 在脚本中动态的设置: `error_reporting()`函数

| 值   | 说明 |
| :----: | ---- |
| `E_ALL ^ E_NOTICE` | 屏蔽 NOTICE |
| `E_ALL ^ E_WARNING` | 屏蔽 WARNING |
| `E_ALL ^ (E_NOTICE | E_WARNING)` | 屏蔽 NOTICE 和 WARNING |
| `E_ALL ^ (E_NOTICE | E_WARNING | E_ERROR)` | 屏蔽 NOTICE / WARNING / ERROR |

----

## 5. 写错误日志

> 以下操作，均需要修改`php.ini`配置文件

### 5.1 将错误报告写入到 指定的文件中

| 配置项 | 说明 | 行数 (大约) |
| ---- | ---- | ---- |
| error_reporting = E_ALL | 将向 PHP 发送每个错误 | Line 445 |
| display_errors = Off | 不显示错误报告 | Line 462 |
| log_errors = On | 开启日志语句记录 | Line 483 |
| log_errors_max_len = 1024 | 每个日志项的最大长度(字节)，0为最大长度 | Line 488 |
| error_log = /data/error/error.log | 指定错误日志写进的文件 | Line 568 |

### 5.2 将错误报告写入到 系统日志中

> 前四项同上

| 配置项 | 说明 | 行数 (大约) |
| ---- | ---- | ---- |
| error_log = syslog | 设置为 写入系统日志中 | Line 568 |

----

## 6. 自定义错误处理

### 6.1 `trigger_error()`
```php
// 使用`trigger_error()`函数，代替`die()`
trigger_error('这是用户自定义的 notice 错误信息', E_USER_NOTICE);
trigger_error('这是用户自定义的 warning 错误信息', E_USER_WARNING);
trigger_error('这是用户自定义的 error 错误信息', E_USER_ERROR);
```

### 6.2 `set_error_handler()`
```php
// 使用`set_error_handler()`自定义错误处理
function error_info ($error_level, $error_msg, $error_file, $error_line)
{
    echo '错误号' . $error_level . ': ';
    echo '错误信息:<font color="#f00" size="5">' . $error_msg . '</font>';
    echo '文件为:' . $error_file;
    echo '<font color="#f00" size="5">[line: ' . $error_line . ']</font><br>';
}

// 重新注册`error_info`函数为错误处理函数.
set_error_handler('error_info');
// 以下级别的错误 不能由用户定义的函数 来处理：
// E_ERROR、 E_PARSE、 E_CORE_ERROR、 E_CORE_WARNING、 E_COMPILE_ERROR、 E_COMPILE_WARNING，和在调用 set_error_handler() 函数所在文件中产生的大多数 E_STRICT
```

----

# 日期和时间
>Unix 时间戳： 我们存储在数据中的时间格式，一般是以 UNIX 时间戳的形式存储的。
>
> 自从 Unix 纪元(格林威治时间 1970 年 1 月 1 日 00:00:00)到当前时间的秒数。


## 相关的时间函数

| 函数                             | 说明                                             |
| -------------------------------- | ------------------------------------------------ |
| time()                           | 返回当前 UNIX 时间戳                             |
| mktime()                         | 取得一个日期的 UNIX 时间戳                       |
| strtotime()                      | 将任何英文文本的日期时间，描述解析为 Unix 时间戳 |
| date()                           | 格式化一个时间/日期                              |
| date_default_timezone_get()      | 获取当前的时区                                   |
| date_default_timezone_set('PRC') | 设置当前的时区 (PRC -- 中国)                     |
| getdate()                        | 获取日期/时间信息                                |


## PS. 倒计时 计算示例

```php
// 当前时间
$now = time();
// 设定结束时间，转成时间戳
$endtime = strtotime("2020-07-24 20:00:00");

// 获取结束时间 到现在时间的时间戳（秒数）
$second = $endtime - $now;
// 从这个时间戳中换算出年头数
$year = floor($second / 3600 / 24 / 365);
// 从时间戳中去掉整年的秒数，就剩下月份的秒数
$temp = $second - $year * 365 * 24 * 3600;
// 从这个时间戳中换算出月数
$month = floor($temp / 3600 / 24 / 30);
// 从时间戳中去掉整月的秒数，就剩下天的秒数
$temp = $temp - $month * 30 * 24 * 3600;
// 从这个时间戳中换算出剩余的天数
$day = floor($temp / 3600 / 24);

// 从时间戳中去掉整天的秒数，就剩下小时的秒数
$temp = $temp - $day * 3600 * 24;
// 从这个时间戳中换算出剩余的小时数
$hour = floor($temp / 3600);
// 从时间戳中去掉整小时的秒数，就剩下分的秒数
$temp = $temp - $hour * 3600;
// 从这个时间戳中换算出剩余的分数
$minute = floor($temp / 60);
// 最后就只有剩余的秒数了
$second1 = $temp - $minute * 60;

echo "距离2020年'东京奥运会'开幕时间还有 : {$year}年{$month}月{$day}天{$hour}小时{$minute}分{$second1}秒";

```
